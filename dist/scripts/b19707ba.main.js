function initChart(a,b){function c(a){a.children&&(a._children=a.children,a._children.forEach(c),a.children=null)}var d=a.map(function(a){return a["Födelseår"]}).filter(function(a){return a>0});yearScale.domain([d3.min(d),d3.max(d)]),root=a[0],root.children=treeify(b,parentIdColumn,childIdColumn),root.x0=height/2,root.y0=0,root.children.forEach(c),update(root)}function update(a){var b=tree.nodes(root).reverse(),c=tree.links(b);b.forEach(function(a){a.y=yearScale(a["Födelseår"])});var d=svg.selectAll("g.node").data(b,function(a){return a.id||(a.id=++i)}),e=d.enter().append("g").attr("class","node").classed("alive",function(a){return a["Nu levande"]}).attr("transform",function(b){return"translate("+a.y0+","+a.x0+")"});e.append("circle").attr("r",1e-6).style("fill",function(a){return a._children?"lightsteelblue":"#fff"});var f=20,g=4*f,h=15,j=10,k=e.append("g").attr("class","partner").classed("no-partner",function(a){return!a.hasPartner}).attr("transform","translate("+[0,f]+")");k.append("path").attr("class","heart").attr("d","M23.6,0c-3.4,0-6.3,2.7-7.6,5.6C14.7,2.7,11.8,0,8.4,0C3.8,0,0,3.8,0,8.4c0,9.4,9.5,11.9,16,21.2c6.1-9.3,16-12.1,16-21.2C32,3.8,28.2,0,23.6,0z").attr("transform","translate("+[-j/2,-j/2]+"), scale(0.3)"),k.append("text").attr("x",function(a,b){return 0==a.depth?-h:h}).attr("dy",".35em").attr("text-anchor",function(a,b){return 0==a.depth?"end":"start"}).attr("class","name partner").text(function(a){return a.Partner}),e.append("text").attr("x",function(a,b){return 0==a.depth?-h:h}).attr("dy",".35em").attr("text-anchor",function(a,b){return 0==a.depth?"end":"start"}).attr("class","name person").text(function(a){return a.Person+" ("+a["Födelseår"]+")"}).style("fill-opacity",1e-6);var l=defs.selectAll("pattern").data(b,function(a){return a.id||(a.id=++i)}),m=l.enter().append("pattern").attr("id",function(a){return"portrait-"+a.id}).attr("patternUnits","userSpaceOnUse").attr("x",f/2).attr("y",f/2).attr("height",f).attr("width",f);m.append("image").attr("height",f).attr("width",f).attr("x",0).attr("y",0).attr("xlink:href",function(a){return""==a.ImageUrl?"images/placeholder.png":a.ImageUrl}),defExit=l.exit().remove(),e.append("circle").attr("x",-f/2).attr("y",-f/2).attr("r",f/2).attr("class","portrait").style("fill",function(a){return"url(#portrait-"+a.id+")"});var n=140,o=e.append("rect").attr("class","clickable-area").attr("width",n).attr("y",-f/2).attr("x",function(a,b){return 0==a.depth?-n+f/2:-f/2}).attr("height",f).attr("fill","#fff").attr("opacity",1e-6).attr("stroke","none");o.on("click",click).on("mouseover",function(a){a.hasPortrait&&(d3.select(this.parentNode).select(".portrait").transition().duration(200).attr("r",g/2).attr("x",-g/2).attr("y",-g/2),d3.select("#portrait-"+a.id).transition().duration(200).attr("x",g/2).attr("y",g/2).attr("width",g).attr("height",g),d3.select("#portrait-"+a.id).select("image").transition().duration(200).attr("width",g).attr("height",g))}).on("mouseout",function(a){d3.select(this.parentNode).select(".portrait").transition().duration(200).attr("r",f/2).attr("x",-f/2).attr("y",-f/2),d3.select("#portrait-"+a.id).transition().duration(200).attr("x",f/2).attr("y",f/2).attr("width",f).attr("height",f),d3.select("#portrait-"+a.id).select("image").transition().duration(200).attr("width",f).attr("height",f)});var p=d.transition().duration(duration).attr("transform",function(a){return"translate("+a.y+","+a.x+")"});p.selectAll(".name").style("fill-opacity",1);var q=d.exit().transition().duration(duration).attr("transform",function(b){return"translate("+a.y+","+a.x+")"}).remove();q.select("circle").attr("r",1e-6),q.select("text").style("fill-opacity",1e-6);var r=svg.selectAll("path.link").data(c,function(a){return a.target.id});r.enter().insert("path","g").attr("class","link").attr("d",function(b){var c={x:a.x0,y:a.y0};return diagonal({source:c,target:c})}),r.transition().duration(duration).attr("d",diagonal),r.exit().transition().duration(duration).attr("d",function(b){var c={x:a.x,y:a.y};return diagonal({source:c,target:c})}).remove(),b.forEach(function(a){a.x0=a.x,a.y0=a.y})}function click(a){a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null),update(a)}function getDataFromCSV(a){d3.csv("data/Hallgrens släktträd - Personer.csv",function(b,c){if(b)throw b;d3.csv("data/Hallgrens släktträd - Relationer.csv",function(b,d){if(b)throw b;var e=prepareData(c,d);a(e.nodes,e.edges)})})}function getDataFromGoogleSpreadsheet(a){Tabletop.init({key:"1RWInLMTyAt1DSjXdnvPqOTd9lAE87UjTTZLY2ZENpts",callback:function(b,c){var d=c.sheets("Personer").elements,e=c.sheets("Relationer").elements,b=prepareData(d,e);a(b.nodes,b.edges)},simpleSheet:!0})}function prepareData(a,b){return a.map(function(a){a["Födelseår"]=+a["Födelseår"],a["Lingarödelägare"]="TRUE"==a["Lingarödelägare"],a["Nu levande"]="TRUE"==a["Nu levande"],a.hasPartner=""!==a.Partner,a.hasPortrait=""!==a.ImageUrl}),persons=a.reduce(function(a,b){return a[b[personIdColum]]=b,a},{}),b=b.map(function(a){return a=mergeObjects(a,persons[a[childIdColumn]])}),{nodes:a,edges:b}}function treeify(a,b,c){var d=a.reduce(function(a,b){return a[b[c]]=b,a},{}),e=[];return a.forEach(function(a){var c=d[a[b]];c?(c.children||(c.children=[])).push(a):e.push(a)}),e}function mergeObjects(a,b){var c={};for(var d in a)c[d]=a[d];for(var d in b)c[d]=b[d];return c}var margin={top:20,right:120,bottom:20,left:120},width=1160-margin.right-margin.left,height=800-margin.top-margin.bottom,i=0,duration=750,root,tree=d3.layout.tree().size([height,width]),diagonal=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),svg=d3.select("#chart").append("svg").attr("width",width+margin.right+margin.left).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),defs=svg.insert("svg:defs").attr("id","defs"),yearScale=d3.scale.linear().range([0,width]),nameColumn="Person",parentIdColumn="Förälderns id",childIdColumn="Barnets id",personIdColum="Id",persons={};d3.select(self.frameElement).style("height","800px");var queryString=function(){for(var a={},b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if("undefined"==typeof a[e[0]])a[e[0]]=e[1];else if("string"==typeof a[e[0]]){var f=[a[e[0]],e[1]];a[e[0]]=f}else a[e[0]].push(e[1])}return a}(),dataSource="undefined"==typeof queryString.csv?getDataFromGoogleSpreadsheet:getDataFromCSV;dataSource(function(a,b){initChart(a,b)});