function initChart(a,b){function c(a){a.children&&(a._children=a.children,a._children.forEach(c),a.children=null)}var d=a.map(function(a){return a["Födelseår"]}).filter(function(a){return a>0});yearScale.domain([d3.min(d),d3.max(d)]),root=a[0],root.children=treeify(b,parentIdColumn,childIdColumn),root.x0=height/2,root.y0=0,root.children.forEach(c),update(root)}function update(a){var b=tree.nodes(root).reverse(),c=tree.links(b);b.forEach(function(a){a.y=yearScale(a["Födelseår"])});var d=svg.selectAll("g.node").data(b,function(a){return a.id||(a.id=++i)}),e=d.enter().append("g").attr("class","node").classed("alive",function(a){return a["Nu levande"]}).attr("transform",function(b){return"translate("+a.y0+","+a.x0+")"}).on("click",click);e.append("circle").attr("r",1e-6).style("fill",function(a){return a._children?"lightsteelblue":"#fff"});var f=36;e.append("rect").attr("x",-f/2).attr("y",-f/2).attr("width",f).attr("height",f).attr("fill","#fff").attr("stroke","red").attr("stroke-width",function(a){return a["Lingarödelägare"]?"3px":"0"}),e.append("image").attr("xlink:href","images/hugo.png").attr("x",-f/2).attr("y",-f/2).attr("width",f).attr("height",f).attr("class","portrait"),e.append("text").attr("x",function(a){return a.children||a._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(a){return a.children||a._children?"end":"start"}).text(function(a){return a.Person+" ("+a["Födelseår"]+")"}).style("fill-opacity",1e-6);var g=d.transition().duration(duration).attr("transform",function(a){return"translate("+a.y+","+a.x+")"});g.select("circle").attr("r",10).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}),g.select("text").style("fill-opacity",1);var h=d.exit().transition().duration(duration).attr("transform",function(b){return"translate("+a.y+","+a.x+")"}).remove();h.select("circle").attr("r",1e-6),h.select("text").style("fill-opacity",1e-6);var j=svg.selectAll("path.link").data(c,function(a){return a.target.id});j.enter().insert("path","g").attr("class","link").attr("d",function(b){var c={x:a.x0,y:a.y0};return diagonal({source:c,target:c})}),j.transition().duration(duration).attr("d",diagonal),j.exit().transition().duration(duration).attr("d",function(b){var c={x:a.x,y:a.y};return diagonal({source:c,target:c})}).remove(),b.forEach(function(a){a.x0=a.x,a.y0=a.y})}function click(a){a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null),update(a)}function getDataFromCSV(a){d3.csv("data/Hallgrens släktträd - Personer.csv",function(b,c){if(b)throw b;d3.csv("data/Hallgrens släktträd - Relationer.csv",function(b,d){if(b)throw b;var e=prepareData(c,d);a(e.nodes,e.edges)})})}function getDataFromGoogleSpreadsheet(a){Tabletop.init({key:"1RWInLMTyAt1DSjXdnvPqOTd9lAE87UjTTZLY2ZENpts",callback:function(b,c){var d=c.sheets("Personer").elements,e=c.sheets("Relationer").elements,b=prepareData(d,e);a(b.nodes,b.edges)},simpleSheet:!0})}function prepareData(a,b){return a.map(function(a){a["Födelseår"]=+a["Födelseår"],a["Lingarödelägare"]="TRUE"==a["Lingarödelägare"],a["Nu levande"]="TRUE"==a["Nu levande"]}),persons=a.reduce(function(a,b){return a[b[personIdColum]]=b,a},{}),b=b.map(function(a){return a=mergeObjects(a,persons[a[childIdColumn]])}),{nodes:a,edges:b}}function treeify(a,b,c){var d=a.reduce(function(a,b){return a[b[c]]=b,a},{}),e=[];return a.forEach(function(a){var c=d[a[b]];c?(c.children||(c.children=[])).push(a):e.push(a)}),e}function mergeObjects(a,b){var c={};for(var d in a)c[d]=a[d];for(var d in b)c[d]=b[d];return c}var margin={top:20,right:120,bottom:20,left:120},width=1160-margin.right-margin.left,height=800-margin.top-margin.bottom,i=0,duration=750,root,tree=d3.layout.tree().size([height,width]),diagonal=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),svg=d3.select("#chart").append("svg").attr("width",width+margin.right+margin.left).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),yearScale=d3.scale.linear().range([0,width]),nameColumn="Person",parentIdColumn="Förälderns id",childIdColumn="Barnets id",personIdColum="Id",persons={};d3.select(self.frameElement).style("height","800px");var queryString=function(){for(var a={},b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if("undefined"==typeof a[e[0]])a[e[0]]=e[1];else if("string"==typeof a[e[0]]){var f=[a[e[0]],e[1]];a[e[0]]=f}else a[e[0]].push(e[1])}return a}(),dataSource="undefined"==typeof queryString.csv?getDataFromGoogleSpreadsheet:getDataFromCSV;dataSource(function(a,b){initChart(a,b)});